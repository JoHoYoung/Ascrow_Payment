<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sharescrow.sample.repository.ProductRepository">
  <select id="selectProducts" resultType="product" parameterType="map">
    SELECT
      *
    FROM
      product
    LIMIT
      #{offset}, #{pageSize}
  </select>

  <select id="selectProductsWithoutHistory" resultType="product" parameterType="map">
    SELECT
      *
    FROM product
    LEFT JOIN product_history ON product.product_no = product_history.product_no
    WHERE
      product_history.product_history_seq IS NULL
    LIMIT #{_skiprows}, #{_pagesize}
  </select>

  <select id="selectProduct" resultType="product">
    SELECT
      *
    FROM
      product
    WHERE
      product_no = #{productNo}
  </select>

  <insert id="insertProduct" parameterType="product" useGeneratedKeys="true" keyProperty="productNo">
    INSERT INTO product
    (
      product_id
      , product_name
      , price
    )
    VALUES
    (
      #{productId}
      , #{productName}
      , #{price}
    )
  </insert>

  <update id="updateProduct" parameterType="map">
    UPDATE product
    SET
      product_name = #{product.productName}
      , price = #{product.price}
      , update_ymdt = NOW()
    WHERE
      product_no = #{productNo}
  </update>

    <insert id="insertProductHistories" parameterType="product" useGeneratedKeys="false">
    INSERT INTO product_history
    (
      product_no
      , product_id
      , product_name
      , price
      , create_ymdt
    )
    VALUES
    <foreach collection="productHistories" item="productHistory" open="(" close=")" separator=",">
    (
      #{productHistory.productNo}
      , #{productHistory.productId}
      , #{productHistory.productName}
      , #{productHistory.price}
      , NOW()
    )
    </foreach>
  </insert>
</mapper>